
#  ‚ñà‚ñà‚ñë ‚ñà‚ñà ‚ñì‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñì     ‚ñà‚ñà‚ñì     ‚ñí‚ñà‚ñà‚ñà‚ñà‚ñà     ‚ñà     ‚ñà‚ñë ‚ñí‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñÄ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñì    ‚ñì‚ñà‚ñà‚ñà‚ñà‚ñà‚ñÑ 
# ‚ñì‚ñà‚ñà‚ñë ‚ñà‚ñà‚ñí‚ñì‚ñà   ‚ñÄ ‚ñì‚ñà‚ñà‚ñí    ‚ñì‚ñà‚ñà‚ñí    ‚ñí‚ñà‚ñà‚ñí  ‚ñà‚ñà‚ñí   ‚ñì‚ñà‚ñë ‚ñà ‚ñë‚ñà‚ñë‚ñí‚ñà‚ñà‚ñí  ‚ñà‚ñà‚ñí‚ñì‚ñà‚ñà ‚ñí ‚ñà‚ñà‚ñí‚ñì‚ñà‚ñà‚ñí    ‚ñí‚ñà‚ñà‚ñÄ ‚ñà‚ñà‚ñå
# ‚ñí‚ñà‚ñà‚ñÄ‚ñÄ‚ñà‚ñà‚ñë‚ñí‚ñà‚ñà‚ñà   ‚ñí‚ñà‚ñà‚ñë    ‚ñí‚ñà‚ñà‚ñë    ‚ñí‚ñà‚ñà‚ñë  ‚ñà‚ñà‚ñí   ‚ñí‚ñà‚ñë ‚ñà ‚ñë‚ñà ‚ñí‚ñà‚ñà‚ñë  ‚ñà‚ñà‚ñí‚ñì‚ñà‚ñà ‚ñë‚ñÑ‚ñà ‚ñí‚ñí‚ñà‚ñà‚ñë    ‚ñë‚ñà‚ñà   ‚ñà‚ñå
# ‚ñë‚ñì‚ñà ‚ñë‚ñà‚ñà ‚ñí‚ñì‚ñà  ‚ñÑ ‚ñí‚ñà‚ñà‚ñë    ‚ñí‚ñà‚ñà‚ñë    ‚ñí‚ñà‚ñà   ‚ñà‚ñà‚ñë   ‚ñë‚ñà‚ñë ‚ñà ‚ñë‚ñà ‚ñí‚ñà‚ñà   ‚ñà‚ñà‚ñë‚ñí‚ñà‚ñà‚ñÄ‚ñÄ‚ñà‚ñÑ  ‚ñí‚ñà‚ñà‚ñë    ‚ñë‚ñì‚ñà‚ñÑ   ‚ñå
# ‚ñë‚ñì‚ñà‚ñí‚ñë‚ñà‚ñà‚ñì‚ñë‚ñí‚ñà‚ñà‚ñà‚ñà‚ñí‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñí‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñí‚ñë ‚ñà‚ñà‚ñà‚ñà‚ñì‚ñí‚ñë   ‚ñë‚ñë‚ñà‚ñà‚ñí‚ñà‚ñà‚ñì ‚ñë ‚ñà‚ñà‚ñà‚ñà‚ñì‚ñí‚ñë‚ñë‚ñà‚ñà‚ñì ‚ñí‚ñà‚ñà‚ñí‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñí‚ñë‚ñí‚ñà‚ñà‚ñà‚ñà‚ñì 
# ‚ñí ‚ñë‚ñë‚ñí‚ñë‚ñí‚ñë‚ñë ‚ñí‚ñë ‚ñë‚ñë ‚ñí‚ñë‚ñì  ‚ñë‚ñë ‚ñí‚ñë‚ñì  ‚ñë‚ñë ‚ñí‚ñë‚ñí‚ñë‚ñí‚ñë    ‚ñë ‚ñì‚ñë‚ñí ‚ñí  ‚ñë ‚ñí‚ñë‚ñí‚ñë‚ñí‚ñë ‚ñë ‚ñí‚ñì ‚ñë‚ñí‚ñì‚ñë‚ñë ‚ñí‚ñë‚ñì  ‚ñë ‚ñí‚ñí‚ñì  ‚ñí 
# ‚ñí ‚ñë‚ñí‚ñë ‚ñë ‚ñë ‚ñë  ‚ñë‚ñë ‚ñë ‚ñí  ‚ñë‚ñë ‚ñë ‚ñí  ‚ñë  ‚ñë ‚ñí ‚ñí‚ñë      ‚ñí ‚ñë ‚ñë    ‚ñë ‚ñí ‚ñí‚ñë   ‚ñë‚ñí ‚ñë ‚ñí‚ñë‚ñë ‚ñë ‚ñí  ‚ñë ‚ñë ‚ñí  ‚ñí 
# ‚ñë  ‚ñë‚ñë ‚ñë   ‚ñë     ‚ñë ‚ñë     ‚ñë ‚ñë   ‚ñë ‚ñë ‚ñë ‚ñí       ‚ñë   ‚ñë  ‚ñë ‚ñë ‚ñë ‚ñí    ‚ñë‚ñë   ‚ñë   ‚ñë ‚ñë    ‚ñë ‚ñë  ‚ñë 
# ‚ñë  ‚ñë  ‚ñë   ‚ñë  ‚ñë    ‚ñë  ‚ñë    ‚ñë  ‚ñë    ‚ñë ‚ñë         ‚ñë        ‚ñë ‚ñë     ‚ñë         ‚ñë  ‚ñë   ‚ñë    
# ‚ñë      

#                         TUITS DE AMLO SOBRE SEGURIDAD           
# ==============================================================================

# üìö INFO DEL SCRIPT ===========================================================
# Autor: Jes√∫s Alejandro Tello Ch√°irez
# Fecha: julio de 2025
# Proyecto: Discurso y pol√≠ticas de seguridad en M√©xico, El Salvador y Colombia
# Notas: Script exploratorio con visuales e ideas sueltas

# üöß TO DO: 
# - [ ] Limpiar texto
# - [ ] Explorar temporalidad
# - [ ] Analizar hashtags y temas
# - [ ] Clasificar tuits por tono o discurso dominante

# üöÄ 0. LIBRER√çAS ==============================================================
# üì¶ Instalar paquetes necesarios si no est√°n ya instalados ----
paquetes <- c("remotes", "wordcloud2", "ggwordcloud", "showtext", "sysfonts")

# Detectar cu√°les no est√°n instalados
instalar <- paquetes[!paquetes %in% installed.packages()]

# Instalar los faltantes desde CRAN
if (length(instalar)) install.packages(instalar)

# Instalar los que est√°n solo en GitHub
remotes::install_github("lchiffon/wordcloud2")   # Para nubes de palabras interactivas
remotes::install_github("lepennec/ggwordcloud")  # Para nubes con ggplot

suppressPackageStartupMessages({
  library(tidyverse)  # para manipulaci√≥n y visualizaci√≥n de datos
  library(tidytext)
  library(janitor)    # limpieza de nombres
  library(lubridate)  # fechas
  library(stringr)    # manejo de texto
  library(readr)
  library(stopwords)
  library(glue)       # strings con variables
  library(scales)     # etiquetas en ejes
  library(crayon)     # üåà colores en consola
  library(ggwordcloud)    # Nubes de palabras
  library(showtext)       # Fuentes personalizadas
  library(wordcloud2)     # Cargar {wordcloud2}
  library(ggplot2)
  library(glue)
  library(showtext)
})

# ‚öôÔ∏è 1. CONFIGURACI√ìN INICIAL ==================================================
# Cargar fuentes de Google 
font_add_google("Playfair Display", "playfair")
font_add_google("Roboto", "roboto")
font_add_google("Montserrat", "montserrat")
# Activar uso de showtext
showtext_auto()

# Mensaje de confirmaci√≥n
message("‚úîÔ∏è Fuentes cargadas y showtext activado correctamente.")
# cat("‚úîÔ∏è Fuentes cargadas y showtext activado correctamente.\n")

cat(green$bold$underline("\nüíª Iniciando an√°lisis...\n"))

# üìÅ 2. CARGA DE DATOS =========================================================
tuits_amlo <- read_csv("https://raw.githubusercontent.com/jesustello/tuits_presidentes/refs/heads/main/datos/amlo_tuits_texto.csv")
tuits_amlo <- tuits_amlo |> clean_names()

cat(blue$bold("‚úÖ Datos cargados correctamente\n"))

glimpse(tuits_amlo)

# üßπ 3. LIMPIEZA INICIAL ==================================
tuits_amlo <- tuits_amlo |>
  mutate(
    texto = str_to_lower(texto), # pasa todo a min√∫sculas
    texto = str_squish(texto)    # quita espacios extra
  )

# Eliminar frases completas despu√©s de poner en min√∫sculas y antes de tokenizar
frases_a_eliminar <- str_to_lower(c(
  "conferencia matutina",
  "conferencia de prensa",
  "conferencia de prensa matutina",
  "conferencia en vivo",
  "desde palacio nacional",
  "conferencia de prensa en vivo",
  "conferencia",
  "matutina",
  "https://www.eluniversal.com.mx/deportes/la-nba-permitira-que-los-jugadores-consuman-marihuana-ya-no-habra-sanciones/",
  "https://www.pscp.tv/w/cMjKTzF4TlFhYWVySmVhUWJ8MU1ZR05QUG9iTXp4d8hbJbOiWNvgEpQ4oM0gFnSn2gXyDCQomW0h5F-9994B"
))

# Reemplazamos esas frases por vac√≠o ("")
tuits_amlo <- tuits_amlo |> 
  mutate(texto = str_remove_all(texto,
                                regex(paste(frases_a_eliminar, collapse = "|"),
                                      ignore_case = FALSE)))

# Sustituci√≥n de variantes por forma unificada
tuits_amlo <- tuits_amlo |>
  mutate(
    texto = str_replace_all(texto, regex("ee\\.?\\s?uu\\.?", ignore_case = TRUE), "estados unidos"),
    texto = str_replace_all(texto, regex("estados unidos mexicanos", ignore_case = TRUE), "m√©xico"),  # Opcional, si no quieres que cuente como "estados unidos"
    texto = str_replace_all(texto, "armada de m√©xico", "marina nacional"),
    texto = str_replace_all(texto, "estrategia de seguridad", "estrategia nacional de seguridad"),
    texto = str_replace_all(texto, "joe biden", "biden"),
    texto = str_replace_all(texto, "zona metropolitana de monterrey", "monterrey"),
    texto = str_replace_all(texto, "base a√©rea militar santa luc√≠a", "santa luc√≠a")
  )

# Definir frases a conservar como tokens √∫nicos
frases_a_conservar <- c(
  "aeropuerto internacional de tulum",
  "alicia b√°rcena",
  "andr√©s manuel l√≥pez obrador",
  "antony blinken",
  "alejandro mayorkas",
  "armada de m√©xico",
  "baja california",
  "benito ju√°rez garc√≠a",
  "campo marte",
  "casa blanca",
  "ciudad de m√©xico",
  "consejo nacional de seguridad p√∫blica",
  "construyendo el futuro",
  "coyuca de ben√≠tez",
  "cuarta transformaci√≥n",
  "cuitl√°huac garc√≠a",
  "cumbre de am√©rica del norte",
  "dan kildee",
  "da√±os colaterales",
  "de marina",
  "de la defensa nacional",
  "defensa patri√≥tica",
  "delincuencia organizada",
  "di√°logo de seguridad de alto nivel",
  "diego prieto",
  "diego sinhue rodr√≠guez vallejo",
  "don beyer",
  "el salvador",
  "el taj√≠n",
  "el universal",
  "ej√©rcito mexicano",
  "elizabeth sherwood-randall",
  "ernesto lammoglia",
  "estado mexicano",
  "estados unidos",
  "estrategia de seguridad",
  "estrategia nacional de seguridad",
  "ex presidente fox",
  "flores mag√≥n",
  "fuerte de san juan de ul√∫a",
  "fuerza a√©rea mexicana",
  "fuerzas armadas",
  "gabinete de seguridad",
  "gobierno de m√©xico",
  "guadalupe tepeyac",
  "guardia nacional",
  "gustavo petro",
  "heroico colegio militar",
  "huautla de jim√©nez",
  "invasi√≥n estadounidense",
  "isla madre",
  "islas mar√≠as",
  "istmo de tehuantepec",
  "javier corral",
  "jerry carl",
  "jos√© rafael ojeda dur√°n",
  "jos√© revueltas",
  "la monta√±a",
  "las margaritas",
  "l√°zaro c√°rdenas del r√≠o",
  "libro de visitantes",
  "lou correa",
  "luis cresencio sandoval gonz√°lez",
  "madre conchita",
  "maggie hassan",
  "maravat√≠o de ocampo",
  "mar√≠a sabina",
  "marina nacional",
  "mat√≠as romero",
  "medalla belisario dom√≠nguez",
  "medio oriente",
  "muros de agua",
  "nayib bukele",
  "nuevo le√≥n",
  "otay ii",
  "pedro infante",
  "pedro sainz de baranda",
  "polic√≠a federal",
  "programas integrales de bienestar",
  "puerto de guaymas",
  "puerto de veracruz",
  "puerto salina cruz",
  "ramos arizpe",
  "rosa icela rodr√≠guez",
  "rosario ibarra de piedra",
  "san blas",
  "santa cruz xoxocotl√°n",
  "santa luc√≠a",
  "secretar√≠a de marina",
  "secretaria de relaciones exteriores",
  "secretar√≠a de seguridad y protecci√≥n ciudadana",
  "secretario de marina",
  "secretario de la defensa",
  "servidores de la naci√≥n",
  "sistema nacional de b√∫squeda",
  "tianguis tur√≠stico m√©xico",
  "tom carper",
  "tren maya"
)

# Sustituir frases por versi√≥n con guiones bajos para conservarlas como un token
for (frase in frases_a_conservar) {
  frase_token <- str_replace_all(frase, " ", "_")
  tuits_amlo$texto <- str_replace_all(tuits_amlo$texto, frase, frase_token)
}

cat(yellow$bold("\nüßΩ Limpieza inicial completada\n"))

# üí¨ PALABRAS CLAVE O FRECUENTES =======================
# Tokenizaci√≥n y frecuencia
palabras <- tuits_amlo |>
  unnest_tokens(palabra, texto)

# Quitar stopwords, n√∫meros y palabras cortas
stopwords_es <- stopwords::stopwords("es")  # stopwords en espa√±ol

tokens_limpios <- palabras |>
  filter(!palabra %in% stopwords_es) |>        # quitar stopwords
  filter(!str_detect(palabra, "^\\d+$")) |>    # quitar n√∫meros
  filter(str_length(palabra) > 2)               # quitar palabras muy cortas

# Conteo de frecuencia
palabras_conteo <- tokens_limpios |>
  count(palabra, sort = TRUE)

# Visualizar resultados
print(palabras_conteo)

# ‚òÅÔ∏è NUBES DE PALABRAS ==================================
set.seed(123) # Para reproducibilidad
cat("üé≤ Semilla aleatoria establecida en 123\n")

# Crear nube de palabras con {wordcloud2} 
# Versi√≥n b√°sica:
palabras_conteo |>
  filter(n > 5) |> 
  wordcloud2(backgroundColor = "#EAD1FA", color = "#543A74")

# Versi√≥n personalizada:
palabras_conteo |>
  filter(n > 5) |> 
  wordcloud2(
    backgroundColor = "#EAD1FA",
    color = "#543A74",
    rotateRatio = 0.1,   # menos rotaci√≥n
    gridSize = 8,        # m√°s espacio entre palabras
    size = 0.5,          # escala general m√°s peque√±a
    minSize = 11         # tama√±o m√≠nimo de palabra
  )

# Nube de palabras con {ggplot2} y {ggwordcloud}

# Estilo global de los gr√°ficos
theme_set(
  theme_void() +
    theme(plot.background = element_rect(fill = "#EAD1FA", linewidth = 0))
)

# Versi√≥n 1 ggwordcloud
nube_gg1 <- palabras_conteo |> 
  filter(n > 5) |>                      # Filtra solo palabras con m√°s de n apariciones
  ggplot() +
  aes(label = palabra, size = n) +         # Usa 'palabra' como texto y 'n' como tama√±o
  geom_text_wordcloud(                     # Dibuja la nube con forma circular
    shape = "circle", 
    color = "#543A74"
  ) +
  scale_size_continuous(range = c(3, 20))  # Controla tama√±o m√≠nimo y m√°ximo de palabras

# Visualizar
nube_gg1

# Guardar con nombre autom√°tico
ggsave(
  filename = glue("nube_palabras_amlo_{format(Sys.time(), '%Y-%m-%d_%H-%M-%S')}.png"),
       plot = nube_gg1,
       width = 10, height = 8, dpi = 300) # MUY PROBABLEMENTE ME DECANTE POR ESTA OPCI√ìN, SOLO ADAPTANDO ALGUNOS PAR√ÅMETROS

# Versi√≥n 2 ggwordcloud
nube_gg1_13 <- palabras_conteo |> 
  filter(n > 5) |>
  ggplot() +
  aes(
    label = palabra, 
    size = n, 
    color = n,
    family = "montserrat"
  ) +
  geom_text_wordcloud(                     
    shape = "circle",                            # Dibuja la nube con forma circular
    rm_outside = TRUE,                            # Evita superposici√≥n sacando palabras que no caben
    color = "#543A74",
    grid_size = 1.5                     # Controla el espacio entre palabras
  ) +
  scale_size_continuous(range = c(3, 20)) +
  scale_color_gradient(low = "#BFA8E6", high = "#543A74") +
  labs(title = "Palabras m√°s frecuentes sobre seguridad en tuits de AMLO") +  
  theme_void() +
  theme(
    plot.title = element_text(
      hjust = 0.5,               # Centrar t√≠tulo
      size = 26,                 # Tama√±o grande
      family = "playfair",       # Fuente diferente para el t√≠tulo
      face = "bold",
      color = "#543A74"
    ),
    plot.background = element_rect(fill = "#EAD1FA", linewidth = 0)
  )

# Visualizar
nube_gg1_13

# Guardar con nombre autom√°tico
ggsave(
  filename = glue("nube_palabras_amlo_{format(Sys.time(), '%Y-%m-%d_%H-%M-%S')}.png"),
       plot = nube_gg1_13,
       width = 4, height = 3, dpi = 300)

# üß† COMENTARIOS FINALES ===============================
cat(magenta$bold("\n‚ú® An√°lisis preliminar completo. Recuerda guardar avances y hacer backup.\n"))

# =============================================================================================
# =============================================================================================
# =============================================================================================
# =============================================================================================
# =============================================================================================